// REPLIT PROMPT
You are building a multi-tenant CRM. Fix the current bug where new users can see all company names and be assigned to any tenant. Enforce strict tenant isolation as follows:

1. **Database (Drizzle + Postgres)**
- `users` table must include `companyId` referencing `companies.id`.
- Add a composite unique index on `(lower(email), company_id)` so email duplicates are prevented only within the same company.
- Enable RLS and add tenant policies:
  ```sql
  ALTER TABLE users ENABLE ROW LEVEL SECURITY;

  CREATE POLICY users_tenant_select ON users
    FOR SELECT USING (company_id = current_setting('app.tenant')::uuid);

  CREATE POLICY users_tenant_insert ON users
    FOR INSERT WITH CHECK (company_id = current_setting('app.tenant')::uuid);

  CREATE POLICY users_tenant_update ON users
    FOR UPDATE USING (company_id = current_setting('app.tenant')::uuid)
    WITH CHECK (company_id = current_setting('app.tenant')::uuid);
Auth Payload & Middleware

JWT/session must carry { userId, role, tenantId }.

Express middleware sets req.auth from token.

Before each query, set Postgres tenant context:

ts
Copy code
await db.execute(sql`select set_config('app.tenant', ${tenantId}, true);`);
User Creation API

Do not accept tenantId from the client.

Always set companyId from req.auth.tenantId.

Console Manager can create Admin.

Admin can create TeamLeader or SupportWorker.

Nobody can create ConsoleManager.

Example:

ts
Copy code
app.post("/api/users", requireAuth, requireRole('ConsoleManager','Admin'), async (req, res) => {
  const { tenantId, role: creatorRole } = req.auth;
  const dto = CreateUserDto.parse(req.body);

  if (dto.role === 'Admin' && creatorRole !== 'ConsoleManager')
    return res.status(403).json({ error: "Only Console Manager can create Admin" });

  if (dto.role === 'ConsoleManager')
    return res.status(403).json({ error: "Cannot create Console Manager" });

  const rows = await db.insert(users).values({
    email: dto.email,
    role: dto.role,
    companyId: tenantId,
  }).returning();

  res.status(201).json(rows[0]);
});
Frontend Create User Form (React + Tailwind + shadcn/ui)

Fetch current user from /me.

Auto-populate company name in the form, disable the field (read-only).

Do not send tenantId in payload.

tsx
Copy code
const { currentUser } = useAuth();

<form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
  <div>
    <label>Company</label>
    <input value={currentUser.company.name} disabled className="input" />
  </div>
  <div>
    <label>Email</label>
    <input {...register("email")} />
  </div>
  <div>
    <label>Role</label>
    <select {...register("role")}>
      <option value="Admin">Admin</option>
      <option value="TeamLeader">Team Leader</option>
      <option value="SupportWorker">Support Worker</option>
    </select>
  </div>
  <button type="submit">Create</button>
</form>
End Result

Company is auto-populated and locked.

Users can only be created inside the creatorâ€™s tenant.

Database enforces tenant boundaries even if API is bypassed.

Clear role rules prevent privilege escalation.